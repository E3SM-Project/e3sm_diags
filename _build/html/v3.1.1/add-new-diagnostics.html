

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to Add New Diagnostics Runs &mdash; E3SM Diags  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Developer Guide" href="dev_guide/index.html" />
    <link rel="prev" title="Colormaps" href="colormaps.html" />
    <link href="_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            E3SM Diags
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">E3SM Diagnostics Package v3</a></li>
<li class="toctree-l1"><a class="reference internal" href="input-data-requirement.html">Input Data Requirement</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickguides/index.html">Quick Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="config-run.html">Configuration and Running</a></li>
<li class="toctree-l1"><a class="reference internal" href="defining-parameters.html">Defining Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="available-parameters.html">Available Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="colormaps.html">Colormaps</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">How to Add New Diagnostics Runs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#adding-derived-variables">Adding Derived Variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#format-of-the-derived-variables-dictionary">Format of the <code class="docutils literal notranslate"><span class="pre">derived_variables</span></code> dictionary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dev_guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to E3SM Diags</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">E3SM Diags</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">How to Add New Diagnostics Runs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/add-new-diagnostics.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-to-add-new-diagnostics-runs">
<h1>How to Add New Diagnostics Runs<a class="headerlink" href="#how-to-add-new-diagnostics-runs" title="Link to this heading"></a></h1>
<section id="adding-derived-variables">
<h2>Adding Derived Variables<a class="headerlink" href="#adding-derived-variables" title="Link to this heading"></a></h2>
<p>We have a set of built-in derived variables for the E3SM model
diagnostics
<a class="reference external" href="https://github.com/E3SM-Project/e3sm_diags/blob/master/e3sm_diags/derivations/acme.py">here</a>
(search for <code class="docutils literal notranslate"><span class="pre">derived_variables</span></code>). The diagnostics software looks into
the <code class="docutils literal notranslate"><span class="pre">derived_variables</span></code> dictionary for variable keys and operations
needed for deriving new variables (renaming, unit conversions,
calculations, etc).</p>
<p>If users want to, they can add their own derived variables, which is
added to the default list during runtime and overwrites any default
values if there’s a collision. Since derived variables require code,
such functionality cannot be added to json/cfg files. You can do the
following in the parameters script, which is a Python script (ex: the
Python script is <code class="docutils literal notranslate"><span class="pre">run_e3sm_diags.py</span></code> in <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">run_e3sm_diags.py</span> <span class="pre">-d</span> <span class="pre">mydiags.cfg</span></code> or
<code class="docutils literal notranslate"><span class="pre">myparams.py</span></code> in <code class="docutils literal notranslate"><span class="pre">e3sm_diags</span> <span class="pre">-p</span> <span class="pre">myparams.py</span> <span class="pre">-d</span> <span class="pre">mydiags.cfg</span></code>).</p>
<section id="format-of-the-derived-variables-dictionary">
<h3>Format of the <code class="docutils literal notranslate"><span class="pre">derived_variables</span></code> dictionary<a class="headerlink" href="#format-of-the-derived-variables-dictionary" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">derived_variables</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;user_inputted_var&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;output_var1&#39;</span><span class="p">,</span> <span class="s1">&#39;output_var2&#39;</span><span class="p">):</span> <span class="n">function_to_call</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Above is how a <code class="docutils literal notranslate"><span class="pre">derived_variables</span></code> dictionary is formatted.
<code class="docutils literal notranslate"><span class="pre">'user_inputted_var'</span></code> is the variable that is defined in the
<code class="docutils literal notranslate"><span class="pre">variables</span></code> part of the json file. <code class="docutils literal notranslate"><span class="pre">'output_var1'</span></code> and
<code class="docutils literal notranslate"><span class="pre">'output_var2'</span></code> are the variables inside the <code class="docutils literal notranslate"><span class="pre">test_name</span></code> (model)
file.</p>
<p><strong>Example of adding derived variables to a parameters script</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in run_e3sm_diags.py or myparams.py</span>

<span class="k">def</span><span class="w"> </span><span class="nf">albedo_obs</span><span class="p">(</span><span class="n">rsdt</span><span class="p">,</span> <span class="n">rsut</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; TOA (top-of-atmosphere) albedo, (solin - fsntoa) / solin, unit is nondimension &quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">rsut</span> <span class="o">/</span> <span class="n">rsdt</span>
    <span class="n">var</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;dimensionless&quot;</span>
    <span class="n">var</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;TOA albedo&quot;</span>
    <span class="k">return</span> <span class="n">var</span>

<span class="n">derived_variables</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;New_ALBEDO&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;rsdt&#39;</span><span class="p">,</span> <span class="s1">&#39;rsut&#39;</span><span class="p">):</span> <span class="n">albedo_obs</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above code will allow it so that if <code class="docutils literal notranslate"><span class="pre">variables</span> <span class="pre">=</span> <span class="pre">&quot;New_ALBEDO&quot;</span></code> in the
diagnostics file (the json or cfg file) and <code class="docutils literal notranslate"><span class="pre">rsdt</span></code> and <code class="docutils literal notranslate"><span class="pre">rsut</span></code> are
variables in the test (model) file, the <code class="docutils literal notranslate"><span class="pre">albedo_obs()</span></code> function is run
on the <code class="docutils literal notranslate"><span class="pre">rsdt</span></code> and <code class="docutils literal notranslate"><span class="pre">rsut</span></code> variables from the test (model) file.</p>
<p><strong>Note</strong>: Please do check first if our built-in derived variable list already has included what you would like to
calculate. Also, for more advanced users, you can clone our repo and make direct changes to the source code and maybe
create a pull request if you think the derived variable is used frequently. We really appreciate it!</p>
</section>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h2>
<p>The example below will do one diagnostics run globally with the
<code class="docutils literal notranslate"><span class="pre">New_ALBEDO</span></code> variable, annually. Below is the json file, call it
<code class="docutils literal notranslate"><span class="pre">mydiags.cfg</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Diags</span><span class="p">]</span>
<span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lat_lon&#39;</span><span class="p">]</span>
<span class="n">case_id</span> <span class="o">=</span> <span class="s2">&quot;lat_lon_CERES&quot;</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;New_ALBEDO&quot;</span><span class="p">]</span>
<span class="n">ref_name</span> <span class="o">=</span> <span class="s2">&quot;edition_4_ceres_ebaf_toa&quot;</span>
<span class="n">reference_name</span> <span class="o">=</span> <span class="s2">&quot;edition_4_ceres_ebaf_toa&quot;</span>
<span class="n">seasons</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ANN&quot;</span><span class="p">]</span>
<span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span>
<span class="n">contour_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]</span>
<span class="n">diff_levels</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>
</pre></div>
</div>
<p>And below is the parameters file, call it <code class="docutils literal notranslate"><span class="pre">run_e3sm_diags.py</span></code>. This is
to run on aims4. To run on another machine, please edit the
<code class="docutils literal notranslate"><span class="pre">reference_data_path</span></code>, <code class="docutils literal notranslate"><span class="pre">test_data_path</span></code>, and <code class="docutils literal notranslate"><span class="pre">test_name</span></code>
accordingly.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">e3sm_diags.parameter.core_parameter</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoreParameter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">e3sm_diags.run</span><span class="w"> </span><span class="kn">import</span> <span class="n">runner</span>

<span class="n">param</span> <span class="o">=</span> <span class="n">CoreParameter</span><span class="p">()</span>

<span class="n">param</span><span class="o">.</span><span class="n">reference_data_path</span> <span class="o">=</span> <span class="s1">&#39;/space1/test_data/CERES-EBAF/&#39;</span>
<span class="n">param</span><span class="o">.</span><span class="n">test_data_path</span> <span class="o">=</span> <span class="s1">&#39;/space/golaz1/ACME_simulations/20160520.A_WCYCL1850.ne30_oEC.edison.alpha6_01/pp/clim_rgr/0070-0099/&#39;</span>

<span class="n">param</span><span class="o">.</span><span class="n">test_name</span> <span class="o">=</span> <span class="s1">&#39;20160520.A_WCYCL1850.ne30&#39;</span>

<span class="n">param</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="s1">&#39;vcs&#39;</span>
<span class="n">param</span><span class="o">.</span><span class="n">diff_title</span> <span class="o">=</span> <span class="s1">&#39;Test - Reference&#39;</span>
<span class="n">param</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">=</span> <span class="s1">&#39;myresults&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">albedo_obs</span><span class="p">(</span><span class="n">rsdt</span><span class="p">,</span> <span class="n">rsut</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TOA (top-of-atmosphere) albedo, (solin - fsntoa) / solin, unit is nondimension&quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">rsut</span> <span class="o">/</span> <span class="n">rsdt</span>
    <span class="n">var</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;dimensionless&quot;</span>
    <span class="n">var</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;TOA albedo&quot;</span>
    <span class="k">return</span> <span class="n">var</span>

<span class="n">param</span><span class="o">.</span><span class="n">derived_variables</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;New_ALBEDO&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;rsdt&#39;</span><span class="p">,</span> <span class="s1">&#39;rsut&#39;</span><span class="p">):</span> <span class="n">albedo_obs</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">runner</span><span class="o">.</span><span class="n">sets_to_run</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lat_lon&#39;</span><span class="p">]</span>
<span class="n">runner</span><span class="o">.</span><span class="n">run_diags</span><span class="p">([</span><span class="n">param</span><span class="p">])</span>
</pre></div>
</div>
<p>Run the command like so:
<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">run_e3sm_diags.py</span> <span class="pre">-d</span> <span class="pre">mydiags.cfg</span></code></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="colormaps.html" class="btn btn-neutral float-left" title="Colormaps" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="dev_guide/index.html" class="btn btn-neutral float-right" title="Developer Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, E3SM.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: v3.1.1
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../v2.10.0/add-new-diagnostics.html">v2.10.0</a></dd>
      <dd><a href="../v2.10.1/add-new-diagnostics.html">v2.10.1</a></dd>
      <dd><a href="../v2.11.0/add-new-diagnostics.html">v2.11.0</a></dd>
      <dd><a href="../v2.12.0/add-new-diagnostics.html">v2.12.0</a></dd>
      <dd><a href="../v2.12.1/add-new-diagnostics.html">v2.12.1</a></dd>
      <dd><a href="../v2.5.0/add-new-diagnostics.html">v2.5.0</a></dd>
      <dd><a href="../v2.6.0/add-new-diagnostics.html">v2.6.0</a></dd>
      <dd><a href="../v2.6.1/add-new-diagnostics.html">v2.6.1</a></dd>
      <dd><a href="../v2.7.0/add-new-diagnostics.html">v2.7.0</a></dd>
      <dd><a href="../v2.8.0/add-new-diagnostics.html">v2.8.0</a></dd>
      <dd><a href="../v2.9.0/add-new-diagnostics.html">v2.9.0</a></dd>
      <dd><a href="../v3.0.0/add-new-diagnostics.html">v3.0.0</a></dd>
      <dd><a href="../v3.0.1/add-new-diagnostics.html">v3.0.1</a></dd>
      <dd><a href="../v3.1.0/add-new-diagnostics.html">v3.1.0</a></dd>
      <dd><a href="add-new-diagnostics.html">v3.1.1</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../main/add-new-diagnostics.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>